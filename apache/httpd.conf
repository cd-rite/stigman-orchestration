# Apache HTTP Server Configuration
# STIG Manager with CAC Authentication

ServerRoot "/usr/local/apache2"
ServerName localhost:443

# Load required modules
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authn_core_module modules/mod_authn_core.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule headers_module modules/mod_headers.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule autoindex_module modules/mod_autoindex.so
LoadModule dir_module modules/mod_dir.so
LoadModule rewrite_module modules/mod_rewrite.so

# Basic server configuration
Listen 443
User daemon
Group daemon

# Logging
ErrorLog /usr/local/apache2/logs/error_log
LogLevel debug
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
CustomLog /usr/local/apache2/logs/access_log combined

# PID file location
PidFile /usr/local/apache2/logs/httpd.pid

# Main virtual host with SSL
<VirtualHost *:443>
    ServerName localhost
    DocumentRoot "/usr/local/apache2/htdocs"

    # Maximum upload size
    LimitRequestBody 104857600

    # SSL Engine Configuration
    SSLEngine on
    SSLCertificateFile "/usr/local/apache2/conf/cert.pem"
    SSLCertificateKeyFile "/usr/local/apache2/conf/privkey.pem"
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on

    # Client Certificate Verification - Optional by default
    SSLCACertificateFile "/usr/local/apache2/conf/dod-certs.pem"
    SSLVerifyClient optional
    SSLVerifyDepth 4
    SSLOptions +StdEnvVars +ExportCertData

    # Root location - serve static content
    <Directory "/usr/local/apache2/htdocs">
        Options Indexes FollowSymLinks
        Require all granted
    </Directory>

    # Proxy to STIG Manager
    <Location "/stigman/">
        ProxyPass "http://stigman:54000/"
        ProxyPassReverse "http://stigman:54000/"
        ProxyPreserveHost On

        # Forward client certificate in PEM format (Apache doesn't have exact nginx equivalent)
        # Using standard format - Keycloak needs to handle decoding
        RequestHeader set ssl-client-cert "%{SSL_CLIENT_CERT}s"
    </Location>

    # Proxy to Keycloak - most endpoints
    <Location "/kc/">
        ProxyPass "http://keycloak:8080/"
        ProxyPassReverse "http://keycloak:8080/"
        ProxyPreserveHost On

        # Forward standard proxy headers
        RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"
        RequestHeader set X-Forwarded-Host "%{HTTP_HOST}s"
        RequestHeader set X-Forwarded-Server "%{SERVER_NAME}s"
        RequestHeader set X-Forwarded-Port "%{SERVER_PORT}s"
        RequestHeader set X-Forwarded-Proto "https"

        # Forward client certificate in PEM format (Apache doesn't have exact nginx equivalent)
        # Using standard format - Keycloak needs to handle decoding
        RequestHeader set ssl-client-cert "%{SSL_CLIENT_CERT}s"
    </Location>

    # Keycloak OAuth endpoint - REQUIRE client certificate (mTLS)
    <Location "/kc/realms/stigman/protocol/openid-connect/auth">
        ProxyPass "http://keycloak:8080/realms/stigman/protocol/openid-connect/auth"
        ProxyPassReverse "http://keycloak:8080/realms/stigman/protocol/openid-connect/auth"
        ProxyPreserveHost On

        # Forward standard proxy headers
        RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"
        RequestHeader set X-Forwarded-Host "%{HTTP_HOST}s"
        RequestHeader set X-Forwarded-Server "%{SERVER_NAME}s"
        RequestHeader set X-Forwarded-Port "%{SERVER_PORT}s"
        RequestHeader set X-Forwarded-Proto "https"

        # Forward client certificate in PEM format (Apache doesn't have exact nginx equivalent)
        # Using standard format - Keycloak needs to handle decoding
        RequestHeader set ssl-client-cert "%{SSL_CLIENT_CERT}s"

        # Return error if no valid certificate (matches nginx behavior)
        # Check if SSL_CLIENT_VERIFY is not SUCCESS (includes NONE, FAILED, etc.)
        <RequireAll>
            Require expr "%{SSL_CLIENT_VERIFY} == 'SUCCESS'"
        </RequireAll>
    </Location>

</VirtualHost>

# Security Headers
Header always set Strict-Transport-Security "max-age=31536000"
