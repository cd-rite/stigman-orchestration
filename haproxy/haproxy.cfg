# HAProxy Configuration for STIG Manager with CAC Authentication
# This configuration provides SSL termination and client certificate forwarding

global
    log stdout format raw local0 debug
    maxconn 4096
    # Required for SSL
    tune.ssl.default-dh-param 2048

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  http-keep-alive
    timeout connect 5s
    timeout client  1h
    timeout server  50s
    timeout tunnel  1h
    timeout http-keep-alive 1s
    # Maximum request body size (100MB)
    maxconn 2000

frontend https_frontend
    bind *:443 ssl crt /usr/local/etc/haproxy/certs/combined.pem ca-file /usr/local/etc/haproxy/certs/dod-certs.pem verify optional

    # ACLs for path-based routing
    acl is_root path /
    acl is_stigman path_beg /stigman
    acl is_keycloak path_beg /kc
    acl is_oauth_endpoint path /kc/realms/stigman/protocol/openid-connect/auth
    acl is_sse path_beg /stigman/api/op/state/sse

    # ACL to check if client certificate is valid
    acl has_valid_cert ssl_c_used ssl_fc_has_crt
    acl cert_verified ssl_c_verify 0

    # For OAuth endpoint, require valid client certificate
    http-request deny if is_oauth_endpoint !has_valid_cert
    http-request deny if is_oauth_endpoint !cert_verified

    # Set client certificate header (base64-encoded DER format, similar to nginx)
    # This matches what Keycloak expects with the "apache" provider
    http-request set-header ssl-client-cert %[ssl_c_der,base64] if { ssl_c_used }

    # Set standard forwarding headers
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Forwarded-Host %[req.hdr(host)]
    http-request set-header X-Forwarded-Server %[req.hdr(host)]
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request set-header X-Forwarded-Proto https

    # Serve landing page at root
    http-request return status 200 content-type text/html lf-file /usr/local/etc/haproxy/index.html if is_root

    # Route to appropriate backend
    use_backend keycloak_backend if is_keycloak
    use_backend stigman_backend if is_stigman

    # Default: redirect to STIG Manager
    default_backend stigman_backend

backend stigman_backend
    # Strip /stigman/ prefix when forwarding to backend (matching nginx/apache behavior)
    # Converts /stigman/foo to /foo
    http-request set-path %[path,regsub(^/stigman/,/)]

    # Preserve Host header
    http-request set-header Host %[req.hdr(host)]

    # SSE-specific settings: long timeouts and no buffering
    timeout server 1h
    timeout tunnel 1h

    # Critical for SSE: disable all buffering
    option http-no-delay
    no option httpclose
    no option http-server-close
    option http-keep-alive

    # Force immediate delivery of response data (disable buffering)
    http-response set-header Connection keep-alive
    http-response set-header Cache-Control no-cache

    server stigman stigman:54000 check

backend keycloak_backend
    # Strip /kc/ prefix when forwarding to backend
    # Converts /kc/foo to /foo
    http-request set-path %[path,regsub(^/kc/,/)]

    # Preserve host header for Keycloak
    http-request set-header Host %[req.hdr(host)]

    server keycloak keycloak:8080 check
